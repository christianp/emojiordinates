<!doctype html>
<html>
    <head>
        <script type="text/javascript" src="//cdn.jsdelivr.net/emojione/2.2.2/lib/js/emojione.min.js"></script>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/emojione/2.2.2/assets/css/emojione.min.css"></link>
        <style type="text/css">
            @font-face {
                font-family: 'OpenSansEmoji';
                src: url('https://cdn.rawgit.com/MorbZ/OpenSansEmoji/master/OpenSansEmoji.otf'); 
            }
            body {
                max-width: 500px;
                margin: 0 auto;
            }

            section {
                margin: 1em 0;
            }
            .inputs {
                display: flex;
            }

            label {
                flex: 1;
                margin: 0 0.5em;
            }

            input {
                width: 100%;
                font-size: 16px;
            }

            label:first-child {
                margin-left: 0;
            }

            label:last-child {
                margin-right: 0;
            }

            #output {
                font-family: 'OpenSansEmoji';
                font-size: 24px;
                text-align: center;
            }
            #map {
                width: 500px;
                height: 500px;
            }
        </style>
    </head>
    <body>
        <section class="inputs" id="latlong-control">
            <label>Lat <input type="number" id="lat" value="55.046389"></label>
            <label>Long <input type="number" id="long" value="-1.451299"></label>
        </section>
        <section class="inputs" id="emoji-control">
            <label>Emoji <input type="text" id="emoji"></label>
        </section>
        <section><div id="output"></div></section>

        <section id="map"></section>

        <div id="test"></div>
        <script type="text/javascript">
            console.clear();

            emoji = ["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ˜ƒ","ðŸ˜„","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜‹","ðŸ˜Ž","ðŸ˜","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","â˜º","ðŸ™‚","ðŸ¤—","ðŸ˜‡","ðŸ¤“","ðŸ¤”","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ™„","ðŸ˜","ðŸ˜£","ðŸ˜¥","ðŸ˜®","ðŸ¤","ðŸ˜¯","ðŸ˜ª","ðŸ˜«","ðŸ˜´","ðŸ˜Œ","ðŸ˜›","ðŸ˜œ","ðŸ˜","ðŸ˜’","ðŸ˜“","ðŸ˜”","ðŸ˜•","ðŸ™ƒ","ðŸ¤‘","ðŸ˜²","ðŸ˜·","ðŸ¤’","ðŸ¤•","â˜¹","ðŸ™","ðŸ˜–","ðŸ˜ž","ðŸ˜Ÿ","ðŸ˜¤","ðŸ˜¢","ðŸ˜­","ðŸ˜¦","ðŸ˜§","ðŸ˜¨","ðŸ˜©","ðŸ˜¬","ðŸ˜°","ðŸ˜±","ðŸ˜³","ðŸ˜µ","ðŸ˜¡","ðŸ˜ ","ðŸ˜ˆ","ðŸ‘¿","ðŸ‘¹","ðŸ‘º","ðŸ’€","â˜ ","ðŸ‘»","ðŸ‘½","ðŸ‘¾","ðŸ¤–","ðŸ’©","ðŸ˜º","ðŸ˜¸","ðŸ˜¹","ðŸ˜»","ðŸ˜¼","ðŸ˜½","ðŸ™€","ðŸ˜¿","ðŸ˜¾","ðŸ™ˆ","ðŸ™‰","ðŸ™Š","ðŸ‘¦","ðŸ‘§","ðŸ‘¨","ðŸ‘©","ðŸ‘´","ðŸ‘µ","ðŸ‘¶","ðŸ‘±","ðŸ‘®","ðŸ‘²","ðŸ‘³","ðŸ‘·","â›‘","ðŸ‘¸","ðŸ’‚","ðŸŽ…","ðŸ‘°","ðŸ‘¼","ðŸ’†","ðŸ’‡","ðŸ™","ðŸ™Ž","ðŸ™…","ðŸ™†","ðŸ’","ðŸ™‹","ðŸ™‡","ðŸ™Œ","ðŸ™","ðŸ‘¤","ðŸ‘¥","ðŸš¶","ðŸƒ","ðŸ‘¯","ðŸ’ƒ","ðŸ‘«","ðŸ‘¬","ðŸ‘­","ðŸ’","ðŸ’‘","ðŸ‘ª","ðŸ»","ðŸ¼","ðŸ½","ðŸ¾","ðŸ¿","ðŸ’ª","ðŸ‘ˆ","ðŸ‘‰","â˜","ðŸ‘†","ðŸ–•","ðŸ‘‡","âœŒ","ðŸ––","ðŸ¤˜","âœ‹","ðŸ‘Œ","ðŸ‘","ðŸ‘Ž","âœŠ","ðŸ‘Š","ðŸ‘‹","ðŸ‘","ðŸ‘","âœ","ðŸ’…","ðŸ‘‚","ðŸ‘ƒ","ðŸ‘£","ðŸ‘€","ðŸ‘…","ðŸ‘„","ðŸ’‹","ðŸ’˜","â¤","ðŸ’“","ðŸ’”","ðŸ’•","ðŸ’–","ðŸ’—","ðŸ’™","ðŸ’š","ðŸ’›","ðŸ’œ","ðŸ’","ðŸ’ž","ðŸ’Ÿ","â£","ðŸ’Œ","ðŸ’¤","ðŸ’¢","ðŸ’£","ðŸ’¥","ðŸ’¦","ðŸ’¨","ðŸ’«","ðŸ’¬","ðŸ’­","ðŸ‘“","ðŸ‘”","ðŸ‘•","ðŸ‘–","ðŸ‘—","ðŸ‘˜","ðŸ‘™","ðŸ‘š","ðŸ‘›","ðŸ‘œ","ðŸ‘","ðŸŽ’","ðŸ‘ž","ðŸ‘Ÿ","ðŸ‘ ","ðŸ‘¡","ðŸ‘¢","ðŸ‘‘","ðŸ‘’","ðŸŽ©","ðŸŽ“","ðŸ“¿","ðŸ’„","ðŸ’","ðŸ’Ž","ðŸµ","ðŸ’","ðŸ¶","ðŸ•","ðŸ©","ðŸº","ðŸ±","ðŸˆ","ðŸ¦","ðŸ¯","ðŸ…","ðŸ†","ðŸ´","ðŸŽ","ðŸ¦„","ðŸ®","ðŸ‚","ðŸƒ","ðŸ„","ðŸ·","ðŸ–","ðŸ—","ðŸ½","ðŸ","ðŸ‘","ðŸ","ðŸª","ðŸ«","ðŸ˜","ðŸ­","ðŸ","ðŸ€","ðŸ¹","ðŸ°","ðŸ‡","ðŸ»","ðŸ¨","ðŸ¼","ðŸ¾","ðŸ¦ƒ","ðŸ”","ðŸ“","ðŸ£","ðŸ¤","ðŸ¥","ðŸ¦","ðŸ§","ðŸ¸","ðŸŠ","ðŸ¢","ðŸ","ðŸ²","ðŸ‰","ðŸ³","ðŸ‹","ðŸ¬","ðŸŸ","ðŸ ","ðŸ¡","ðŸ™","ðŸš","ðŸ¦€","ðŸŒ","ðŸ›","ðŸœ","ðŸ","ðŸž","ðŸ¦‚","ðŸ’","ðŸŒ¸","ðŸ’®","ðŸŒ¹","ðŸŒº","ðŸŒ»","ðŸŒ¼","ðŸŒ·","ðŸŒ±","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŒµ","ðŸŒ¾","ðŸŒ¿","â˜˜","ðŸ€","ðŸ","ðŸ‚","ðŸƒ","ðŸ‡","ðŸˆ","ðŸ‰","ðŸŠ","ðŸ‹","ðŸŒ","ðŸ","ðŸŽ","ðŸ","ðŸ","ðŸ‘","ðŸ’","ðŸ“","ðŸ…","ðŸ†","ðŸŒ½","ðŸ„","ðŸŒ°","ðŸž","ðŸ§€","ðŸ–","ðŸ—","ðŸ”","ðŸŸ","ðŸ•","ðŸŒ­","ðŸŒ®","ðŸŒ¯","ðŸ³","ðŸ²","ðŸ¿","ðŸ±","ðŸ˜","ðŸ™","ðŸš","ðŸ›","ðŸœ","ðŸ","ðŸ ","ðŸ¢","ðŸ£","ðŸ¤","ðŸ¥","ðŸ¡","ðŸ¦","ðŸ§","ðŸ¨","ðŸ©","ðŸª","ðŸŽ‚","ðŸ°","ðŸ«","ðŸ¬","ðŸ­","ðŸ®","ðŸ¯","ðŸ¼","â˜•","ðŸµ","ðŸ¶","ðŸ¾","ðŸ·","ðŸ¸","ðŸ¹","ðŸº","ðŸ»","ðŸ´","ðŸ”ª","ðŸº","ðŸŒ","ðŸŒŽ","ðŸŒ","ðŸŒ","ðŸ—¾","â›°","ðŸŒ‹","ðŸ—»","ðŸ ","ðŸ¡","ðŸ¢","ðŸ£","ðŸ¤","ðŸ¥","ðŸ¦","ðŸ¨","ðŸ©","ðŸª","ðŸ«","ðŸ¬","ðŸ­","ðŸ¯","ðŸ°","ðŸ’’","ðŸ—¼","ðŸ—½","â›ª","ðŸ•Œ","ðŸ•","â›©","ðŸ•‹","â›²","â›º","ðŸŒ","ðŸŒƒ","ðŸŒ„","ðŸŒ…","ðŸŒ†","ðŸŒ‡","ðŸŒ‰","â™¨","ðŸŒŒ","ðŸŽ ","ðŸŽ¡","ðŸŽ¢","ðŸ’ˆ","ðŸŽª","ðŸŽ­","ðŸŽ¨","ðŸŽ°","ðŸš‚","ðŸšƒ","ðŸš„","ðŸš…","ðŸš†","ðŸš‡","ðŸšˆ","ðŸš‰","ðŸšŠ","ðŸš","ðŸšž","ðŸš‹","ðŸšŒ","ðŸš","ðŸšŽ","ðŸš","ðŸš","ðŸš‘","ðŸš’","ðŸš“","ðŸš”","ðŸš•","ðŸš–","ðŸš—","ðŸš˜","ðŸš™","ðŸšš","ðŸš›","ðŸšœ","ðŸš²","â›½","ðŸš¨","ðŸš¥","ðŸš¦","ðŸš§","âš“","â›µ","ðŸš£","ðŸš¤","â›´","ðŸš¢","âœˆ","ðŸ›«","ðŸ›¬","ðŸ’º","ðŸš","ðŸšŸ","ðŸš ","ðŸš¡","ðŸš€","ðŸšª","ðŸ›Œ","ðŸš½","ðŸš¿","ðŸ›€","ðŸ›","âŒ›","â³","âŒš","â°","â±","â²","ðŸ•›","ðŸ•§","ðŸ•","ðŸ•œ","ðŸ•‘","ðŸ•","ðŸ•’","ðŸ•ž","ðŸ•“","ðŸ•Ÿ","ðŸ•”","ðŸ• ","ðŸ••","ðŸ•¡","ðŸ•–","ðŸ•¢","ðŸ•—","ðŸ•£","ðŸ•˜","ðŸ•¤","ðŸ•™","ðŸ•¥","ðŸ•š","ðŸ•¦","ðŸŒ‘","ðŸŒ’","ðŸŒ“","ðŸŒ”","ðŸŒ•","ðŸŒ–","ðŸŒ—","ðŸŒ˜","ðŸŒ™","ðŸŒš","ðŸŒ›","ðŸŒœ","â˜€","ðŸŒ","ðŸŒž","â­","ðŸŒŸ","ðŸŒ ","â˜","â›…","â›ˆ","ðŸŒ€","ðŸŒˆ","ðŸŒ‚","â˜‚","â˜”","â›±","âš¡","â„","â˜ƒ","â›„","â˜„","ðŸ”¥","ðŸ’§","ðŸŒŠ","ðŸŽƒ","ðŸŽ„","ðŸŽ†","ðŸŽ‡","âœ¨","ðŸŽˆ","ðŸŽ‰","ðŸŽŠ","ðŸŽ‹","ðŸŽ","ðŸŽŽ","ðŸŽ","ðŸŽ","ðŸŽ‘","ðŸŽ€","ðŸŽ","ðŸŽ«","ðŸ†","ðŸ…","âš½","âš¾","ðŸ€","ðŸ","ðŸˆ","ðŸ‰","ðŸŽ¾","ðŸŽ±","ðŸŽ³","ðŸ","ðŸ‘","ðŸ’","ðŸ“","ðŸ¸","â›³","â›¸","ðŸŽ£","ðŸŽ½","ðŸŽ¿","â›·","ðŸ‚","ðŸ„","ðŸ‡","ðŸŠ","â›¹","ðŸš´","ðŸšµ","ðŸŽ¯","ðŸŽ®","ðŸŽ²","â™ ","â™¥","â™¦","â™£","ðŸƒ","ðŸŽ´","ðŸ”‡","ðŸ”ˆ","ðŸ”‰","ðŸ”Š","ðŸ“¢","ðŸ“£","ðŸ“¯","ðŸ””","ðŸ”•","ðŸŽ¼","ðŸŽµ","ðŸŽ¶","ðŸŽ¤","ðŸŽ§","ðŸ“»","ðŸŽ·","ðŸŽ¸","ðŸŽ¹","ðŸŽº","ðŸŽ»","ðŸ“±","ðŸ“²","â˜Ž","ðŸ“ž","ðŸ“Ÿ","ðŸ“ ","ðŸ”‹","ðŸ”Œ","ðŸ’»","âŒ¨","ðŸ’½","ðŸ’¾","ðŸ’¿","ðŸ“€","ðŸŽ¥","ðŸŽ¬","ðŸ“º","ðŸ“·","ðŸ“¸","ðŸ“¹","ðŸ“¼","ðŸ”","ðŸ”Ž","ðŸ”¬","ðŸ”­","ðŸ“¡","ðŸ’¡","ðŸ”¦","ðŸ®","ðŸ“”","ðŸ“•","ðŸ“–","ðŸ“—","ðŸ“˜","ðŸ“™","ðŸ“š","ðŸ““","ðŸ“’","ðŸ“ƒ","ðŸ“œ","ðŸ“„","ðŸ“°","ðŸ“‘","ðŸ”–","ðŸ’°","ðŸ’´","ðŸ’µ","ðŸ’¶","ðŸ’·","ðŸ’¸","ðŸ’³","ðŸ’¹","ðŸ’±","ðŸ’²","âœ‰","ðŸ“§","ðŸ“¨","ðŸ“©","ðŸ“¤","ðŸ“¥","ðŸ“¦","ðŸ“«","ðŸ“ª","ðŸ“¬","ðŸ“­","ðŸ“®","âœ","âœ’","ðŸ“","ðŸ’¼","ðŸ“","ðŸ“‚","ðŸ“…","ðŸ“†","ðŸ“‡","ðŸ“ˆ","ðŸ“‰","ðŸ“Š","ðŸ“‹","ðŸ“Œ","ðŸ“","ðŸ“Ž","ðŸ“","ðŸ“","âœ‚","ðŸ”’","ðŸ”“","ðŸ”","ðŸ”","ðŸ”‘","ðŸ”¨","â›","âš’","âš”","ðŸ”«","ðŸ¹","ðŸ”§","ðŸ”©","âš™","âš—","âš–","ðŸ”—","â›“","ðŸ’‰","ðŸ’Š","ðŸš¬","âš°","âš±","ðŸ—¿","ðŸ”®","ðŸ§","ðŸš®","ðŸš°","â™¿","ðŸš¹","ðŸšº","ðŸš»","ðŸš¼","ðŸš¾","ðŸ›‚","ðŸ›ƒ","ðŸ›„","ðŸ›…","âš ","ðŸš¸","â›”","ðŸš«","ðŸš³","ðŸš­","ðŸš¯","ðŸš±","ðŸš·","ðŸ“µ","ðŸ”ž","â˜¢","â˜£","â¬†","â†—","âž¡","â†˜","â¬‡","â†™","â¬…","â†–","â†•","â†”","â†©","â†ª","â¤´","â¤µ","ðŸ”ƒ","ðŸ”„","ðŸ”™","ðŸ”š","ðŸ”›","ðŸ”œ","ðŸ”","ðŸ›","âš›","âœ¡","â˜¸","â˜¯","âœ","â˜¦","â˜ª","â˜®","ðŸ•Ž","ðŸ”¯","â™»","ðŸ“›","âšœ","ðŸ”°","ðŸ”±","â­•","âœ…","â˜‘","âœ”","âœ–","âŒ","âŽ","âž•","âž–","âž—","âž°","âž¿","ã€½","âœ³","âœ´","â‡","â€¼","â‰","â“","â”","â•","â—","ã€°","Â©","Â®","â„¢","â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™Ž","â™","â™","â™‘","â™’","â™“","â›Ž","ðŸ”€","ðŸ”","ðŸ”‚","â–¶","â©","â­","â¯","â—€","âª","â®","ðŸ”¼","â«","ðŸ”½","â¬","â¸","â¹","âº","ðŸŽ¦","ðŸ”…","ðŸ”†","ðŸ“¶","ðŸ“³","ðŸ“´","ðŸ”Ÿ","ðŸ’¯","ðŸ” ","ðŸ”¡","ðŸ”¢","ðŸ”£","ðŸ”¤","ðŸ†Ž","ðŸ†‘","ðŸ†’","ðŸ†“","â„¹","ðŸ†”","â“‚","ðŸ†•","ðŸ†–","ðŸ†—","ðŸ†˜","ðŸ†™","ðŸ†š","ðŸˆ","ðŸˆ¶","ðŸ‰","ðŸˆ¹","ðŸˆ²","ðŸ‰‘","ðŸˆ¸","ðŸˆ´","ðŸˆ³","ãŠ—","ãŠ™","ðŸˆº","ðŸˆµ","â–ª","â–«","â—»","â—¼","â—½","â—¾","â¬›","â¬œ","ðŸ”¶","ðŸ”·","ðŸ”¸","ðŸ”¹","ðŸ”º","ðŸ”»","ðŸ’ ","ðŸ”˜","ðŸ”²","ðŸ”³","âšª","âš«","ðŸ”´","ðŸ”µ","ðŸ","ðŸš©","ðŸŽŒ","ðŸ´"];

            var numSymbols = emoji.length;
            var precision = Math.floor(Math.sqrt(Math.sqrt(Math.pow(numSymbols,4)/2-0.25)-0.5));
            console.log(numSymbols,precision);

            function encode(lat,long) {
                var sign = long > 0 ? 1 : 0;
                long = Math.abs(long)/180;
                lat = (lat+90)/180;
                lat = Math.floor(precision*precision*lat);
                long = Math.floor(precision*precision*long)*(precision*precision);
                var n = lat+long+(Math.pow(precision,4)+Math.pow(precision,2))*sign;
                console.log('encode',n);
                var digits = [];
                var d = [];
                for(var i=0;i<4;i++) {
                    var m = n%numSymbols;
                    d.push(m);
                    digits.push(emoji[m]);
                    n = (n-m)/numSymbols;
                }
                console.log(d);
                return digits.join('');
            }

            function decode(s) {
                var digits = [];
                while(s.length) {
                    for(var i=0;i<emoji.length;i++) {
                        var e = emoji[i];
                        if(s.slice(0,e.length)==e) {
                            digits.push(i);
                            s = s.slice(e.length);
                            break;
                        }
                    }
                    if(i==emoji.length) {
                        throw("Not emoji: "+s);
                    }
                }
                console.log(digits);
                var n = 0;
                for(var i=digits.length-1;i>=0;i--) {
                    n = n*numSymbols + digits[i];
                }
                var swap = Math.pow(precision,4)+Math.pow(precision,2);
                var sign = n>swap;
                console.log(swap);
                console.log('decode',n,sign);
                var lat = n%(precision*precision);
                var long = (n-lat)/(precision*precision);
                lat = 180*(lat/(precision*precision))-90;
                long = 180*(sign+long/(precision*precision));
                if(sign==0) {
                    long = -long;
                }
                return {lat:lat,lng:long};
            }

            var latInput = document.getElementById('lat');
            var longInput = document.getElementById('long');
            var emojiInput = document.getElementById('emoji');
            var output = document.getElementById('output');

            function update() {
                var lat = parseFloat(latInput.value);
                var long = parseFloat(longInput.value);
                var rep = encode(lat,long);
                output.innerHTML = emojione.toImage(rep);
                emojiInput.value = rep;
                location.hash='#'+rep;
            }

            update();
            latInput.addEventListener('input',update);
            longInput.addEventListener('input',update);

            function updateEmoji() {
                var v = emojiInput.value;
                setFromEmoji(v);
            }

            function setFromEmoji(v) {
                var pos = decode(v);
                latInput.value = pos.lat;
                longInput.value = pos.lng;
                if(map) {
                    map.setCenter(pos);
                }
            }

            emojiInput.addEventListener('input',updateEmoji);

            var map;

            function initMap() {
                var myLatlng = new google.maps.LatLng(latInput.value, longInput.value);
                var mapOptions = {
                    zoom: 15,
                    center: myLatlng,
                    mapTypeId: google.maps.MapTypeId.MAP
                };
                map = new google.maps.Map(document.getElementById("map"),mapOptions);

                var moveTimeout;
                map.addListener('center_changed', function() {
                    var center = map.getCenter();
                    latInput.value = center.lat();
                    longInput.value = center.lng();
                    clearTimeout(moveTimeout);
                    moveTimeout = setTimeout(update,100);
                });

                if(location.hash) {
                    var s = location.hash.slice(1);
                    setFromEmoji(s);
                }
            }

        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZGLoP4NtQ_biRAl9lc35McWZUFbguRDU&callback=initMap" type="text/javascript"></script>
    </body>
</html>
