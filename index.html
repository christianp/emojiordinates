<!doctype html>
<html>
    <head>
        <script type="text/javascript" src="//cdn.jsdelivr.net/emojione/2.2.2/lib/js/emojione.min.js"></script>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/emojione/2.2.2/assets/css/emojione.min.css"></link>
        <style type="text/css">
            @font-face {
                font-family: 'OpenSansEmoji';
                src: url('https://cdn.rawgit.com/MorbZ/OpenSansEmoji/master/OpenSansEmoji.otf'); 
            }
            body {
                max-width: 500px;
                margin: 0 auto;
            }

            section {
                margin: 1em 0;
            }
            .inputs {
                display: flex;
            }

            label {
                flex: 1;
                margin: 0 0.5em;
            }

            input {
                width: 100%;
                font-size: 16px;
            }

            label:first-child {
                margin-left: 0;
            }

            label:last-child {
                margin-right: 0;
            }

            #output {
                font-family: 'OpenSansEmoji';
                font-size: 24px;
                text-align: center;
            }
            #map {
                width: 500px;
                height: 500px;
            }
        </style>
    </head>
    <body>
        <section class="inputs" id="latlong-control">
            <label>Lat <input type="number" id="lat" value="55.046389"></label>
            <label>Long <input type="number" id="long" value="-1.451299"></label>
        </section>
        <section class="inputs" id="emoji-control">
            <label>Emoji <input type="text" id="emoji"></label>
        </section>
        <section><div id="output"></div></section>

        <section id="map"></section>

        <div id="test"></div>
        <script type="text/javascript">
            console.clear();

            emoji = ["😀","😁","😂","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘","😗","😙","😚","☺","🙂","🤗","😇","🤓","🤔","😐","😑","😶","🙄","😏","😣","😥","😮","🤐","😯","😪","😫","😴","😌","😛","😜","😝","😒","😓","😔","😕","🙃","🤑","😲","😷","🤒","🤕","☹","🙁","😖","😞","😟","😤","😢","😭","😦","😧","😨","😩","😬","😰","😱","😳","😵","😡","😠","😈","👿","👹","👺","💀","☠","👻","👽","👾","🤖","💩","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🙈","🙉","🙊","👦","👧","👨","👩","👴","👵","👶","👱","👮","👲","👳","👷","⛑","👸","💂","🎅","👰","👼","💆","💇","🙍","🙎","🙅","🙆","💁","🙋","🙇","🙌","🙏","👤","👥","🚶","🏃","👯","💃","👫","👬","👭","💏","💑","👪","🏻","🏼","🏽","🏾","🏿","💪","👈","👉","☝","👆","🖕","👇","✌","🖖","🤘","✋","👌","👍","👎","✊","👊","👋","👏","👐","✍","💅","👂","👃","👣","👀","👅","👄","💋","💘","❤","💓","💔","💕","💖","💗","💙","💚","💛","💜","💝","💞","💟","❣","💌","💤","💢","💣","💥","💦","💨","💫","💬","💭","👓","👔","👕","👖","👗","👘","👙","👚","👛","👜","👝","🎒","👞","👟","👠","👡","👢","👑","👒","🎩","🎓","📿","💄","💍","💎","🐵","🐒","🐶","🐕","🐩","🐺","🐱","🐈","🦁","🐯","🐅","🐆","🐴","🐎","🦄","🐮","🐂","🐃","🐄","🐷","🐖","🐗","🐽","🐏","🐑","🐐","🐪","🐫","🐘","🐭","🐁","🐀","🐹","🐰","🐇","🐻","🐨","🐼","🐾","🦃","🐔","🐓","🐣","🐤","🐥","🐦","🐧","🐸","🐊","🐢","🐍","🐲","🐉","🐳","🐋","🐬","🐟","🐠","🐡","🐙","🐚","🦀","🐌","🐛","🐜","🐝","🐞","🦂","💐","🌸","💮","🌹","🌺","🌻","🌼","🌷","🌱","🌲","🌳","🌴","🌵","🌾","🌿","☘","🍀","🍁","🍂","🍃","🍇","🍈","🍉","🍊","🍋","🍌","🍍","🍎","🍏","🍐","🍑","🍒","🍓","🍅","🍆","🌽","🍄","🌰","🍞","🧀","🍖","🍗","🍔","🍟","🍕","🌭","🌮","🌯","🍳","🍲","🍿","🍱","🍘","🍙","🍚","🍛","🍜","🍝","🍠","🍢","🍣","🍤","🍥","🍡","🍦","🍧","🍨","🍩","🍪","🎂","🍰","🍫","🍬","🍭","🍮","🍯","🍼","☕","🍵","🍶","🍾","🍷","🍸","🍹","🍺","🍻","🍴","🔪","🏺","🌍","🌎","🌏","🌐","🗾","⛰","🌋","🗻","🏠","🏡","🏢","🏣","🏤","🏥","🏦","🏨","🏩","🏪","🏫","🏬","🏭","🏯","🏰","💒","🗼","🗽","⛪","🕌","🕍","⛩","🕋","⛲","⛺","🌁","🌃","🌄","🌅","🌆","🌇","🌉","♨","🌌","🎠","🎡","🎢","💈","🎪","🎭","🎨","🎰","🚂","🚃","🚄","🚅","🚆","🚇","🚈","🚉","🚊","🚝","🚞","🚋","🚌","🚍","🚎","🚏","🚐","🚑","🚒","🚓","🚔","🚕","🚖","🚗","🚘","🚙","🚚","🚛","🚜","🚲","⛽","🚨","🚥","🚦","🚧","⚓","⛵","🚣","🚤","⛴","🚢","✈","🛫","🛬","💺","🚁","🚟","🚠","🚡","🚀","🚪","🛌","🚽","🚿","🛀","🛁","⌛","⏳","⌚","⏰","⏱","⏲","🕛","🕧","🕐","🕜","🕑","🕝","🕒","🕞","🕓","🕟","🕔","🕠","🕕","🕡","🕖","🕢","🕗","🕣","🕘","🕤","🕙","🕥","🕚","🕦","🌑","🌒","🌓","🌔","🌕","🌖","🌗","🌘","🌙","🌚","🌛","🌜","☀","🌝","🌞","⭐","🌟","🌠","☁","⛅","⛈","🌀","🌈","🌂","☂","☔","⛱","⚡","❄","☃","⛄","☄","🔥","💧","🌊","🎃","🎄","🎆","🎇","✨","🎈","🎉","🎊","🎋","🎍","🎎","🎏","🎐","🎑","🎀","🎁","🎫","🏆","🏅","⚽","⚾","🏀","🏐","🏈","🏉","🎾","🎱","🎳","🏏","🏑","🏒","🏓","🏸","⛳","⛸","🎣","🎽","🎿","⛷","🏂","🏄","🏇","🏊","⛹","🚴","🚵","🎯","🎮","🎲","♠","♥","♦","♣","🃏","🎴","🔇","🔈","🔉","🔊","📢","📣","📯","🔔","🔕","🎼","🎵","🎶","🎤","🎧","📻","🎷","🎸","🎹","🎺","🎻","📱","📲","☎","📞","📟","📠","🔋","🔌","💻","⌨","💽","💾","💿","📀","🎥","🎬","📺","📷","📸","📹","📼","🔍","🔎","🔬","🔭","📡","💡","🔦","🏮","📔","📕","📖","📗","📘","📙","📚","📓","📒","📃","📜","📄","📰","📑","🔖","💰","💴","💵","💶","💷","💸","💳","💹","💱","💲","✉","📧","📨","📩","📤","📥","📦","📫","📪","📬","📭","📮","✏","✒","📝","💼","📁","📂","📅","📆","📇","📈","📉","📊","📋","📌","📍","📎","📏","📐","✂","🔒","🔓","🔏","🔐","🔑","🔨","⛏","⚒","⚔","🔫","🏹","🔧","🔩","⚙","⚗","⚖","🔗","⛓","💉","💊","🚬","⚰","⚱","🗿","🔮","🏧","🚮","🚰","♿","🚹","🚺","🚻","🚼","🚾","🛂","🛃","🛄","🛅","⚠","🚸","⛔","🚫","🚳","🚭","🚯","🚱","🚷","📵","🔞","☢","☣","⬆","↗","➡","↘","⬇","↙","⬅","↖","↕","↔","↩","↪","⤴","⤵","🔃","🔄","🔙","🔚","🔛","🔜","🔝","🛐","⚛","✡","☸","☯","✝","☦","☪","☮","🕎","🔯","♻","📛","⚜","🔰","🔱","⭕","✅","☑","✔","✖","❌","❎","➕","➖","➗","➰","➿","〽","✳","✴","❇","‼","⁉","❓","❔","❕","❗","〰","©","®","™","♈","♉","♊","♋","♌","♍","♎","♏","♐","♑","♒","♓","⛎","🔀","🔁","🔂","▶","⏩","⏭","⏯","◀","⏪","⏮","🔼","⏫","🔽","⏬","⏸","⏹","⏺","🎦","🔅","🔆","📶","📳","📴","🔟","💯","🔠","🔡","🔢","🔣","🔤","🆎","🆑","🆒","🆓","ℹ","🆔","Ⓜ","🆕","🆖","🆗","🆘","🆙","🆚","🈁","🈶","🉐","🈹","🈲","🉑","🈸","🈴","🈳","㊗","㊙","🈺","🈵","▪","▫","◻","◼","◽","◾","⬛","⬜","🔶","🔷","🔸","🔹","🔺","🔻","💠","🔘","🔲","🔳","⚪","⚫","🔴","🔵","🏁","🚩","🎌","🏴"];

            var numSymbols = emoji.length;
            var precision = Math.floor(Math.sqrt(Math.sqrt(Math.pow(numSymbols,4)/2-0.25)-0.5));
            console.log(numSymbols,precision);

            function encode(lat,long) {
                var sign = long > 0 ? 1 : 0;
                long = Math.abs(long)/180;
                lat = (lat+90)/180;
                lat = Math.floor(precision*precision*lat);
                long = Math.floor(precision*precision*long)*(precision*precision);
                var n = lat+long+(Math.pow(precision,4)+Math.pow(precision,2))*sign;
                console.log('encode',n);
                var digits = [];
                var d = [];
                for(var i=0;i<4;i++) {
                    var m = n%numSymbols;
                    d.push(m);
                    digits.push(emoji[m]);
                    n = (n-m)/numSymbols;
                }
                console.log(d);
                return digits.join('');
            }

            function decode(s) {
                var digits = [];
                while(s.length) {
                    for(var i=0;i<emoji.length;i++) {
                        var e = emoji[i];
                        if(s.slice(0,e.length)==e) {
                            digits.push(i);
                            s = s.slice(e.length);
                            break;
                        }
                    }
                    if(i==emoji.length) {
                        throw("Not emoji: "+s);
                    }
                }
                console.log(digits);
                var n = 0;
                for(var i=digits.length-1;i>=0;i--) {
                    n = n*numSymbols + digits[i];
                }
                var swap = Math.pow(precision,4)+Math.pow(precision,2);
                var sign = n>swap;
                console.log(swap);
                console.log('decode',n,sign);
                var lat = n%(precision*precision);
                var long = (n-lat)/(precision*precision);
                lat = 180*(lat/(precision*precision))-90;
                long = 180*(sign+long/(precision*precision));
                if(sign==0) {
                    long = -long;
                }
                return {lat:lat,lng:long};
            }

            var latInput = document.getElementById('lat');
            var longInput = document.getElementById('long');
            var emojiInput = document.getElementById('emoji');
            var output = document.getElementById('output');

            function update() {
                var lat = parseFloat(latInput.value);
                var long = parseFloat(longInput.value);
                var rep = encode(lat,long);
                output.innerHTML = emojione.toImage(rep);
                emojiInput.value = rep;
                location.hash='#'+rep;
            }

            update();
            latInput.addEventListener('input',update);
            longInput.addEventListener('input',update);

            function updateEmoji() {
                var v = emojiInput.value;
                setFromEmoji(v);
            }

            function setFromEmoji(v) {
                var pos = decode(v);
                latInput.value = pos.lat;
                longInput.value = pos.lng;
                if(map) {
                    map.setCenter(pos);
                }
            }

            emojiInput.addEventListener('input',updateEmoji);

            var map;

            function initMap() {
                var myLatlng = new google.maps.LatLng(latInput.value, longInput.value);
                var mapOptions = {
                    zoom: 15,
                    center: myLatlng,
                    mapTypeId: google.maps.MapTypeId.MAP
                };
                map = new google.maps.Map(document.getElementById("map"),mapOptions);

                var moveTimeout;
                map.addListener('center_changed', function() {
                    var center = map.getCenter();
                    latInput.value = center.lat();
                    longInput.value = center.lng();
                    clearTimeout(moveTimeout);
                    moveTimeout = setTimeout(update,100);
                });

                if(location.hash) {
                    var s = location.hash.slice(1);
                    setFromEmoji(s);
                }
            }

        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZGLoP4NtQ_biRAl9lc35McWZUFbguRDU&callback=initMap" type="text/javascript"></script>
    </body>
</html>
